<!DOCTYPE html>

<title>ASCIIcon</title>

<meta charset="utf-8"></meta>
<link type="text/css" href="default.css" rel="stylesheet"></link> 

<header>
    <h1>ASCIIcon</h1>
</header>

<article>
    <label for="gridSize">Size</label></td>
    <select id="gridSize">
         <option value="9"  mod="5" selected>9 x 9</option>
         <option value="11" mod="3">11 x 11</option>
         <option value="15" mod="4">15 x 15</option>
         <option value="19" mod="5">19 x 19</option>
         <option value="23" mod="4">23 x 23</option>
    <select>
    <input id="create" type="button" value="Create New">

    <table width="1%">        
        <tr>
            <td width="1%">
                <div id="paper">
                    <textarea id="vertices" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                    <textarea id="segments" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                </div>
            </td>
            <td width="1%">
                <div id="iconFrame">
                    <canvas id="icon" width="300" height="300"></canvas>
                </div>
                <table>
                    <tr>
                        <td colspan="3">
                            <input id="render" type="button" value="Render">
                        </td>
                    </tr><tr>
                        <td><label for="iconTop">Top</label></td>
                        <td><input id="iconTop" type="text" value="10" size="5"></td>
                    </tr><tr>
                        <td><label for="iconLeft">Left</label></td>
                        <td><input id="iconLeft" type="text" value="10" size="5"></td>
                    </tr><tr>
                        <td><label for="iconWidth">Width</label></td>
                        <td><input id="iconWidth" type="text" value="200" size="5"></td>
                    </tr><tr>
                        <td><label for="iconHeight">Height</label></td>
                        <td><input id="iconHeight" type="text" value="200" size="5"></td>
                    </tr><tr>
                        <td><label for="debugGrid">Grid</label></td>
                        <td><input id="debugGrid" type="checkbox"></td>
                    </tr><tr>
                        <td><label for="debugSegments">Segments</label></td>
                        <td><input id="debugSegments" type="checkbox"></td>
                    </tr><tr>
                        <td><label for="autoRender">Auto-render</label></td>
                        <td><input id="autoRender" type="checkbox"></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</article>

<script src="ascii-icon.js"></script>

<script
    src="https://code.jquery.com/jquery-3.0.0.js"
    integrity="sha256-jrPLZ+8vDxt2FnE1zvZXCkCcebI/C8Dt5xyaQBjxQIo="
    crossorigin="anonymous"
></script>
        
<script>

$( function() {
    var SNAPSHOT = 'snapshot';

    var stateId = {
        vertices      : stateValue,
        segments      : stateValue,
        iconLeft      : stateValue,
        iconTop       : stateValue,
        iconWidth     : stateValue,
        iconHeight    : stateValue,
        gridSize      : stateValue,        
        debugGrid     : stateCheckbox,
        debugSegments : stateCheckbox,
    };

    $( '#vertices' ).keydown( verticesKeydown ).keyup( verticesKeyup ).click( verticesKeyup )
    $( '#segments' ).keydown( segmentsKeyup )
    $( '#create' ).click( changeSize )
    $( '#render' ).click( drawIcon )
    $( '#debugGrid,#debugSegments' ).click( autoRender )
    $( '#iconHeight,#iconWidth,#iconTop,#iconLeft' ).keyup( autoRender )

    // var param = parseQueryParameeters();

    // if ( param.text ) {
    //     var text = param.text.split( '\n\n' )
    //     $( '#vertices' ).val( text.shift() )
    //     $( '#segments' ).val( text.join( '\n\n' ))
    // }

    var loaded = load( SNAPSHOT );

    var gridSize = Number( $( '#gridSize' ).val() );
    var gridMod = Number( $( '#gridSize' ).find( ':selected' ).attr( 'mod' ) );
    console.log( gridSize, gridMod );

    if ( loaded )
        adjustHeight();
    else 
        createIcon();

    autoRender();

    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    function verticesKeydown( ev ) {
        switch ( ev.keyCode ) {
        case 8:  // backspace
        case 46: // delete
            ev.preventDefault()
            break;

        default:
            // console.log( 'down', ev.keyCode );
            return;
        }
    }

    function verticesKeyup( ev ) {
        var st = ev.target.selectionStart,
            x = st % (gridSize + 1),
            y = Math.floor( st / (gridSize + 1) );

        if ( ev.keyCode ) {
            if ( ev.keyCode >= 48 && ev.keyCode <= 192 )
                st -= 1;
            else 
                switch ( ev.keyCode ) {
                case 40: // down
                    if ( y < (gridSize-1) )
                        st += gridSize;
                    else 
                        $( '#segments' ).focus()
                        // st -= 1;
                    break;

                case 38: // up
                    if ( y > 0 )
                        st -= gridSize + 1;
                    break;

                case 39: // right
                    if ( x == gridSize )
                        st -= 1;
                    break;

                case 37: // left
                    if ( x > 0 )
                        st -= 1;
                    break;

                case 8:  // backspace
                case 46: // delete
                    ev.target.value = ev.target.value.substring(0, st) + placeHolder( x, y ) + ev.target.value.substring(st + 1, ev.target.value.length);
                    // st -= 1;
                    break;

                default:
                    console.log( 'up', ev.keyCode );
                    return;
                }
        }
        // console.log( st, x, y, ev.keyCode );
        ev.target.selectionStart = st;
        ev.target.selectionEnd = st + 1;

        autoRender();
        autoSave();
    }

    function segmentsKeyup( ev ) {
        if ( ev.target.selectionStart == 0 && ev.keyCode == 38 )
            $( '#vertices' ).focus().get( 0 ).selectionStart = (gridSize + 1) * (gridSize - 1);

        autoRender();
        autoSave();
    }

    function autoRender() {
        if ( !$( '#autoRender' ).prop( 'checked' ) ) return;

        drawIcon();
    }

    function autoSave() {
        // console.log( 'autosave' );
        save( SNAPSHOT );
    }

    function drawIcon() {
        var canvas = $( '#icon' ).get( 0 );
        var ctx = canvas.getContext('2d');    

        ctx.clearRect( 0, 0, canvas.width, canvas.height )

        var text = $( '#vertices' ).val() + '\n\n' + $( '#segments' ).val();
        // console.log( text);
        ctx.drawIcon( text, {
            left:     Number( $( '#iconLeft' ).val() ), 
            top:      Number( $( '#iconTop' ).val() ), 
            width:    Number( $( '#iconWidth' ).val() ), 
            height:   Number( $( '#iconHeight' ).val() ), 
            grid:     $( '#debugGrid' ).prop( 'checked' ),
            segments: $( '#debugSegments' ).prop( 'checked' ),
        } )
    }

    function changeSize() {
        gridSize = Number( $( '#gridSize' ).val() );
        gridMod = Number( $( '#gridSize' ).find( ':selected' ).attr( 'mod' ) );

        createIcon();
    }

    function placeHolder( x, y ) {
        return ((x + 1) % gridMod == 0) && ((y + 1) % gridMod == 0) ? ':' : '.';
    }

    function createIcon() {
        var icon = [];
        for ( var r = 0; r < gridSize; r++ ) {
            var row = '';
            for ( var c = 0; c < gridSize; c++ )
                row = row + placeHolder( c, r );
            icon.push( row );
        }

        $( '#vertices' )
            .val( icon.join( '\n' ) )
            .attr( 'rows', gridSize )
            .attr( 'cols', gridSize )

        adjustHeight();
    }

    function adjustHeight() {
        var h = $( '#vertices' )
            .height( '5px' )
            .get( 0 ).scrollHeight;

        $( '#vertices' )
            .height( h + 'px' )
    }

    function parseQueryParameeters() {
        var s = location.search.substr(1);
        var ps = s.split( /&/ );
        var param = {};
        for ( var i = 0; i < ps.length; i++ ) {
            var p = ps[ i ].split( /=/ )
            param[ p[ 0 ] ] = p[ 1 ];
        }
        return param;
    }

    function stateValue( id, value ) {
        if ( arguments.length == 1 )
            return $( '#' + id ).val();

        return $( '#' + id ).val( value );        
    }

    function stateCheckbox( id, checked ) {
        if ( arguments.length == 1 )
            return $( '#' + id ).prop( 'checked' );

        return $( '#' + id ).prop( 'checked', !!checked );
    }

    function stateInternal( id, value ) {
        if ( arguments.length == 1 )
            return internal[ id ]

        internal[ id ] = value;
    }

    function save( name ) {
        var data = {};
        $.each( stateId, function ( id, state ) {
            data[ id ] = state( id )
        } )

        localStorage.setItem( name, JSON.stringify( data ) );
        // console.log( 'saved', name )
    }

    function load( name ) {
        var json = localStorage.getItem( name );
        try {
            var data = JSON.parse( json );
        }
        catch( e ) {
            console.warn( e );
            return false;
        }

        if ( !data ) return false;

        $.each( stateId, function ( id, state ) {
            state( id, data[ id ] )
        } )
        console.log( 'loaded', name )
        return true;
    }
} )

</script>